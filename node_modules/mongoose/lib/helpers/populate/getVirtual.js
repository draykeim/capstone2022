'use strict';

module.exports = getVirtual;

/*!
 * ignore
 */

function getVirtual(schema, name) {
  if (schema.virtuals[name]) {
<<<<<<< HEAD
    return schema.virtuals[name];
  }
=======
    return { virtual: schema.virtuals[name], path: void 0 };
  }

>>>>>>> f48a1595ee4da78cea13c4049a9ef48e9e70b5fa
  const parts = name.split('.');
  let cur = '';
  let nestedSchemaPath = '';
  for (let i = 0; i < parts.length; ++i) {
    cur += (cur.length > 0 ? '.' : '') + parts[i];
    if (schema.virtuals[cur]) {
      if (i === parts.length - 1) {
<<<<<<< HEAD
        schema.virtuals[cur].$nestedSchemaPath = nestedSchemaPath;
        return schema.virtuals[cur];
=======
        return { virtual: schema.virtuals[cur], path: nestedSchemaPath };
>>>>>>> f48a1595ee4da78cea13c4049a9ef48e9e70b5fa
      }
      continue;
    }

    if (schema.nested[cur]) {
      continue;
    }

    if (schema.paths[cur] && schema.paths[cur].schema) {
      schema = schema.paths[cur].schema;
      const rest = parts.slice(i + 1).join('.');

      if (schema.virtuals[rest]) {
        if (i === parts.length - 2) {
<<<<<<< HEAD
          schema.virtuals[rest].$nestedSchemaPath =
            [nestedSchemaPath, cur].filter(v => !!v).join('.');
          return schema.virtuals[rest];
=======
          return {
            virtual: schema.virtuals[rest],
            nestedSchemaPath: [nestedSchemaPath, cur].filter(v => !!v).join('.')
          };
>>>>>>> f48a1595ee4da78cea13c4049a9ef48e9e70b5fa
        }
        continue;
      }

      if (i + 1 < parts.length && schema.discriminators) {
        for (const key of Object.keys(schema.discriminators)) {
<<<<<<< HEAD
          const _virtual = getVirtual(schema.discriminators[key], rest);
          if (_virtual != null) {
            _virtual.$nestedSchemaPath = [nestedSchemaPath, cur].
              filter(v => !!v).join('.');
            return _virtual;
=======
          const res = getVirtual(schema.discriminators[key], rest);
          if (res != null) {
            const _path = [nestedSchemaPath, cur, res.nestedSchemaPath].
              filter(v => !!v).join('.');
            return {
              virtual: res.virtual,
              nestedSchemaPath: _path
            };
>>>>>>> f48a1595ee4da78cea13c4049a9ef48e9e70b5fa
          }
        }
      }

      nestedSchemaPath += (nestedSchemaPath.length > 0 ? '.' : '') + cur;
      cur = '';
      continue;
    }

<<<<<<< HEAD
=======
    if (schema.discriminators) {
      for (const discriminatorKey of Object.keys(schema.discriminators)) {
        const virtualFromDiscriminator = getVirtual(schema.discriminators[discriminatorKey], name);
        if (virtualFromDiscriminator) return virtualFromDiscriminator;
      }
    }

>>>>>>> f48a1595ee4da78cea13c4049a9ef48e9e70b5fa
    return null;
  }
}
